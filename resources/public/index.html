<html>
<head>
    <title>Socket Debugger</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
    <script type="text/javascript" src="js/soundmanager/script/soundmanager2.js"></script>
    <script type="text/javascript" src="js/client/main.js"></script>
    <script type="text/javascript">
        // Initialize drumcirclr main client library & sound support 
        dc.init();

        $(function () {
          dc.logTarget = $('#log');
          dc.logMessage = function (level,msg) {
            dc.logTarget.append("<div class='debug-log " + level + "'>" + msg + "</div>")

          };
          dc.log = {
            debug: function (msg) {
              dc.logMessage("debug", msg);
            },
            info: function (msg) {
              dc.logMessage("info", msg);
            },
            warn: function (msg) {
              dc.logMessage("info", msg);
            },
            fatal: function (msg) {
              dc.logMessage("info", msg);
            }
          };
          var log = dc.log;
          dc.userId = null;

          dc.sock = new WebSocket("ws://192.168.15.5:3001/connect");
          dc.sock.onopen = function () {
            log.info("Socket open")
            dc.sock.send('{"cmd":"get-user-id"}');
          };
          dc.sock.onerror = function (msg) {
            log.warn("Socket error: " + msg);
          };
          dc.sock.onclose = function (msg) {
            log.info("Socket closed: " + msg);
          };
          dc.sock.onmessage = function (msgRaw) {
            var msg = JSON.parse(msgRaw.data);
            if (msg.cmd === "play") {
              if (msg["user-id"] !== dc.userId) {
                dc.testSound.play();
              }
            } else if (msg.cmd === "set-user-id") {
              dc.userId = msg["user-id"];
            }
            log.info("Rx: " + msgRaw.data);
          }

          dc.login = function (token, succCallback, errCallback) {
            log.info("Logging in with token: " + token);
            $.post("/login", {token: token}).success(function (data) {
                log.info("Successfully logged in!")
                if (typeof(succCallback) != "undefined") {
                  succCallback();
                }
            }).error(function (data) {
              log.info("Error logging in: " + data);
              console.log(data);
              if (typeof(errCallback) != "undefined") {
                errCallback();
              }
            });
          }

          $('#command-input').submit(function (e) {
            e.preventDefault();
            var cmd = $('#command').val();
            log.info("Tx: " + cmd);
            dc.sock.send(cmd);
          })

          $('body').keydown(function(event) {
            if (event.keyCode === 32) {
                event.preventDefault();
                dc.testSound.play();
                dc.sock.send('{"cmd": "play", "sound": "snare"}');
            }
          });

        });
    </script>
</head>
<body>
  <h2><strong style="color: #5FFB17">dc</strong> Debug Log</h2>
  <div id="log" style="height: 220px; width:400px; overflow: scroll; border: 1px solid silver;"></div>
  <div style="border-top: 1px solid silver; margin: 7px 0px; padding: 7px 0px;">
      <form id="command-input">
          <strong>Command Input</strong>
          <br>
          <input type="text" id="command">
          <input type="submit">
      </form>

      <h2>Press spacebar to play a snare</h2>
  </div>
</body>
</html>

